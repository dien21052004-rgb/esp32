<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hệ Thống Giám Sát 3 Pha — ERa/ESP32</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- JustGage + Raphael -->
<script src="https://cdn.jsdelivr.net/npm/raphael@2.3.0/raphael.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/justgage@1.6.1/justgage.min.js"></script>
<!-- EraWidget -->
<script src="https://cdn.jsdelivr.net/npm/era-widget@latest/dist/era-widget.min.js"></script>

<style>
:root{
  --bg:#07162a; --card:#10263f; --accent:#00f0ff; --muted:#9fb2c8;
  --status-ok:#0f0; --status-off:#f00; --status-wait:#ff0;
}
body{margin:0;font-family:Inter,Segoe UI,Arial;background:var(--bg);color:#fff}
header{padding:12px 18px;background:linear-gradient(90deg,#0b2945 0%, #07172a 100%);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap}
header h1{font-size:18px;margin:0;color:var(--accent)}
.top{display:flex;gap:12px;padding:14px;flex-wrap:wrap;justify-content:flex-start;align-items:center}
.stat{background:var(--card);padding:10px 14px;border-radius:10px;min-width:110px;text-align:center;box-shadow:0 6px 18px rgba(0,0,0,0.4)}
.stat h3{margin:0;font-size:12px;color:var(--muted)}
.stat h2{margin:4px 0 0;font-size:18px;color:var(--accent)}
.status{display:flex;align-items:center;gap:6px;font-size:13px;color:#fff;}
.status-dot{width:12px;height:12px;border-radius:50%;background:var(--status-wait);}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:16px}
.card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.5)}
canvas{background:transparent}
.btn{background:#0b84ff;border:none;padding:6px 12px;border-radius:6px;color:#fff;cursor:pointer}
pre{margin:0;font-size:12px;line-height:1.2}
@media(max-width:1000px){ .grid{grid-template-columns:repeat(1,1fr)} }
</style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:10px">
    <h1>Hệ Thống Giám Sát 3 Pha</h1>
  </div>
  <div style="display:flex;gap:12px;align-items:center">
    <div class="small">ESP IP:</div>
    <input id="espIp" type="text" placeholder="192.168.1.100" style="padding:6px;border-radius:6px;border:none" />
    <button id="applyIp" class="btn">Áp dụng</button>
    <select id="sourceSelect" class="btn">
      <option value="era">ERa IoT</option>
      <option value="esp">ESP32</option>
    </select>
  </div>
</header>

<div class="top">
  <div class="stat"><h3>Tần số</h3><h2 id="Freq">-- Hz</h2></div>
  <div class="stat"><h3>Điện áp TB</h3><h2 id="Vavg">-- V</h2></div>
  <div class="stat"><h3>Dòng điện TB</h3><h2 id="Iavg">-- A</h2></div>
  <div class="stat status">
    <span class="status-dot" id="statusDot"></span>
    <span id="statusText">Waiting...</span>
  </div>
</div>

<div class="grid">
  <div class="card"><h3>Điện áp hiệu dụng (V)</h3><canvas id="voltageChart" height="160"></canvas></div>
  <div class="card"><h3>Dòng điện hiệu dụng (A)</h3><canvas id="currentChart" height="160"></canvas></div>
  <div class="card"><h3>Từ thông (Wb)</h3><canvas id="fluxChart" height="160"></canvas></div>
  <div class="card">
    <h3>Gauge điện áp 3 pha</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
      <div id="gVa" style="width:150px;height:110px"></div>
      <div id="gVb" style="width:150px;height:110px"></div>
      <div id="gVc" style="width:150px;height:110px"></div>
    </div>
  </div>
  <div class="card"><h3>Raw JSON</h3><pre id="raw" style="background:#071a2a;padding:8px;border-radius:6px;color:#bcd;height:170px;overflow:auto"></pre></div>
  <div class="card"><h3>Logs</h3><div id="log" style="height:170px;overflow:auto;background:#071a2a;padding:8px;border-radius:6px;font-size:12px;color:#bcd"></div></div>
</div>

<script>
let ESP_BASE = "";
const DEFAULT_POLL = 1000;
const maxPoints = 12;

// Elements
const freqEl = document.getElementById('Freq');
const vavgEl = document.getElementById('Vavg');
const iavgEl = document.getElementById('Iavg');
const rawEl = document.getElementById('raw');
const logEl = document.getElementById('log');
const espIpInput = document.getElementById('espIp');
const applyIpBtn = document.getElementById('applyIp');
const sourceSelect = document.getElementById('sourceSelect');
const statusDot = document.getElementById('statusDot');
const statusText = document.getElementById('statusText');

// Log helper
function log(msg){
  const time = new Date().toLocaleTimeString();
  logEl.innerText = `[${time}] ${msg}\n` + logEl.innerText;
}

// Smooth filter
function smooth(prev, current, alpha=0.2){
  if(isNaN(prev)) return current;
  return prev + alpha*(current - prev);
}

// Charts
const voltageChart = new Chart(document.getElementById('voltageChart'), {type:'line', data:{labels:[], datasets:[{label:'V_A',data:[],borderColor:'#00ffff'},{label:'V_B',data:[],borderColor:'#ffb300'},{label:'V_C',data:[],borderColor:'#ff6a6a'}]}, options:{animation:false,plugins:{legend:{labels:{color:'#bfe'}}}}});
const currentChart = new Chart(document.getElementById('currentChart'), {type:'line', data:{labels:[], datasets:[{label:'I_A',data:[],borderColor:'#7eff8a'},{label:'I_B',data:[],borderColor:'#00b3ff'},{label:'I_C',data:[],borderColor:'#e67aff'}]}, options:{animation:false,plugins:{legend:{labels:{color:'#bfe'}}}}});
const fluxChart = new Chart(document.getElementById('fluxChart'), {type:'line', data:{labels:[], datasets:[{label:'Φ_A',data:[],borderColor:'#faff00'},{label:'Φ_B',data:[],borderColor:'#ff7b00'},{label:'Φ_C',data:[],borderColor:'#00ff95'}]}, options:{animation:false,plugins:{legend:{labels:{color:'#bfe'}}}}});

// Gauges
const gVa = new JustGage({id:'gVa', min:0, max:500, title:'V_A'});
const gVb = new JustGage({id:'gVb', min:0, max:500, title:'V_B'});
const gVc = new JustGage({id:'gVc', min:0, max:500, title:'V_C'});

// Set ESP base
function setESPBase(ip){
  ip = ip.trim();
  if(!ip.startsWith('http')) ip = 'http://' + ip;
  ESP_BASE = ip;
  log('ESP base set to ' + ESP_BASE);
}

// Fetch ESP32 data
async function fetchESPData(){
  if(!ESP_BASE) return;
  try{
    const res = await fetch(ESP_BASE+'/data');
    if(!res.ok) throw new Error(res.statusText);
    const data = await res.json();
    handleData(data);
    statusDot.style.backgroundColor='var(--status-ok)';
    statusText.innerText='ESP Online';
    log('ESP data updated');
  }catch(e){
    statusDot.style.backgroundColor='var(--status-off)';
    statusText.innerText='ESP Offline';
    log('ESP fetch error: '+e.message);
  }
}

// Handle and smooth data
function handleData(data){
  let VA = smooth(window.VA_prev,data.VA||0);
  let VB = smooth(window.VB_prev,data.VB||0);
  let VC = smooth(window.VC_prev,data.VC||0);
  let IA = smooth(window.IA_prev,data.IA||0);
  let IB = smooth(window.IB_prev,data.IB||0);
  let IC = smooth(window.IC_prev,data.IC||0);
  let FA = smooth(window.FA_prev,data.FA||0);
  let FB = smooth(window.FB_prev,data.FB||0);
  let FC = smooth(window.FC_prev,data.FC||0);
  let Freq = smooth(window.Freq_prev,data.Freq||0);

  window.VA_prev=VA; window.VB_prev=VB; window.VC_prev=VC;
  window.IA_prev=IA; window.IB_prev=IB; window.IC_prev=IC;
  window.FA_prev=FA; window.FB_prev=FB; window.FC_prev=FC;
  window.Freq_prev=Freq;

  vavgEl.textContent = ((VA+VB+VC)/3).toFixed(1);
  iavgEl.textContent = ((IA+IB+IC)/3).toFixed(1);
  freqEl.textContent = Freq.toFixed(2)+' Hz';
  rawEl.textContent = JSON.stringify(data,null,2);

  const now = new Date().toLocaleTimeString().slice(0,5);
  [voltageChart,currentChart,fluxChart].forEach(c=>{
    c.data.labels.push(now);
    if(c.data.labels.length>maxPoints)c.data.labels.shift();
  });

  voltageChart.data.datasets[0].data.push(VA);
  voltageChart.data.datasets[1].data.push(VB);
  voltageChart.data.datasets[2].data.push(VC);
  currentChart.data.datasets[0].data.push(IA);
  currentChart.data.datasets[1].data.push(IB);
  currentChart.data.datasets[2].data.push(IC);
  fluxChart.data.datasets[0].data.push(FA);
  fluxChart.data.datasets[1].data.push(FB);
  fluxChart.data.datasets[2].data.push(FC);

  [voltageChart,currentChart,fluxChart].forEach(c=>{
    c.data.datasets.forEach(d=>{if(d.data.length>maxPoints)d.data.shift();});
    c.update();
  });

  gVa.refresh(VA); gVb.refresh(VB); gVc.refresh(VC);
}

// Initialize EraWidget
const eraWidget = new EraWidget();
eraWidget.init({
  onConfiguration:(config)=>{ log('ERa configured'); },
  onValues:(values)=>{ 
    if(sourceSelect.value!=='era') return;
    handleData(values);
    statusDot.style.backgroundColor='var(--status-ok)';
    statusText.innerText='ERa Online';
    log('ERa data updated');
  }
});

// Button actions
applyIpBtn.onclick=()=>{setESPBase(espIpInput.value); if(sourceSelect.value==='esp') fetchESPData();};
setInterval(()=>{
  if(sourceSelect.value==='esp') fetchESPData();
  // ERa data tự động qua widget
}, DEFAULT_POLL);
</script>

</body>
</html>
